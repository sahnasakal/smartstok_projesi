{% extends "_layout.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{{ title }}</h1>
</div>

<div class="row">
    <div class="col-lg-12">
        <h3 class="h4 mb-3">Stok Analizi</h3>
    </div>
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-danger text-white">
                <i class="bi bi-cart-plus-fill me-2"></i>Sipariş Zamanı Gelen Ürünler
            </div>
            <div class="card-body">
                {% if products_to_reorder %}
                <div class="table-responsive">
                    <table id="reorderTable" class="table table-striped table-hover" style="width:100%">
                        <thead>
                            <tr>
                                <th>Ürün</th>
                                <th class="text-center">Günlük Satış</th>
                                <th class="text-center">Kalan Gün</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for analysis in products_to_reorder %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('edit_product', id=analysis.product.id) }}">{{ analysis.product.name }}</a>
                                    <small class="d-block text-muted">{{ analysis.product.barcode }}</small>
                                </td>
                                <td class="text-center">{{ "%.2f"|format(analysis.daily_velocity) }}</td>
                                <td class="text-center fw-bold text-danger">{{ analysis.days_of_supply }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-success text-center mb-0">
                    Acil sipariş gerektiren ürün bulunmuyor.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-lg-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-warning text-dark">
                <i class="bi bi-hourglass-split me-2"></i>Yavaş Hareket Eden (Ölü) Stok
            </div>
            <div class="card-body">
                {% if slow_moving_products %}
                <div class="table-responsive">
                    <table id="slowMovingTable" class="table table-striped table-hover" style="width:100%">
                        <thead>
                            <tr>
                                <th>Ürün</th>
                                <th>Son Hareket Tarihi</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for analysis in slow_moving_products %}
                            <tr>
                                <td>
                                    <a href="{{ url_for('edit_product', id=analysis.product.id) }}">{{ analysis.product.name }}</a>
                                    <small class="d-block text-muted">{{ analysis.product.barcode }}</small>
                                </td>
                                <td>{{ analysis.last_movement_date.strftime('%d-%m-%Y') if analysis.last_movement_date else 'Bilinmiyor' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-secondary text-center mb-0">
                    Yavaş hareket eden ürün bulunmuyor.
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-12 mt-4">
        <h3 class="h4 mb-3">Lokasyon Analizi (Son 30 Gün)</h3>
        <div class="card">
            <div class="card-header bg-info text-white">
                <i class="bi bi-grid-3x3-gap-fill me-2"></i>Depo Aktivite Raporu
            </div>
            <div class="card-body">
                {% if location_activity %}
                <div class="table-responsive">
                    <table id="locationActivityTable" class="table table-striped table-hover" style="width:100%">
                        <thead>
                            <tr>
                                <th>Lokasyon</th>
                                <th class="text-center">Toplam Hareket</th>
                                <th class="text-center">Durum</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for analysis in location_activity %}
                            <tr>
                                <td>{{ analysis.location.barcode }}</td>
                                <td class="text-center fw-bold">{{ analysis.total_movements }}</td>
                                <td class="text-center">
                                    {% if analysis.status == 'HOT_ZONE' %}
                                        <span class="badge bg-danger">Sıcak Bölge</span>
                                    {% elif analysis.status == 'COLD_ZONE' %}
                                        <span class="badge bg-primary">Soğuk Bölge</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Normal</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-secondary text-center mb-0">
                    Analiz edilecek lokasyon verisi bulunamadı.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    var tableOptions = {
        "language": {
            "url": "//cdn.datatables.net/plug-ins/1.13.6/i18n/tr.json"
        },
        "pageLength": 10,
        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "Tümü"]]
    };
    $('#reorderTable').DataTable(tableOptions);
    $('#slowMovingTable').DataTable(tableOptions);
    $('#locationActivityTable').DataTable(tableOptions);
});
</script>
{% endblock %}